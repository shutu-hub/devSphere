<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.shutu.devSphere.mapper.MomentLikeMapper">

    <!-- 查询是否点过赞 -->
    <select id="hasLiked" resultType="int">
        SELECT COUNT(1)
        FROM moment_like
        WHERE moment_id = #{momentId}
          AND user_id = #{userId}
          AND deleted = 0
    </select>

    <!-- 点赞数量 +1 -->
    <update id="incrLikeCount">
        UPDATE moments_post
        SET like_count = like_count + 1
        WHERE id = #{momentId}
    </update>

    <!-- 点赞数量 -1 -->
    <update id="decrLikeCount">
        UPDATE moments_post
        SET like_count = like_count - 1
        WHERE id = #{momentId}
    </update>

    <!-- 插入点赞（如果不存在） -->
    <insert id="insertLikeIfNotExist">
        INSERT INTO moment_like (id, post_id, user_id, create_time)
        SELECT
            #{params.id,jdbcType=BIGINT},
            #{params.post_id},
            #{params.user_id},
            NOW()
        FROM DUAL
        WHERE NOT EXISTS (
            SELECT 1 FROM moment_like
            WHERE post_id = #{params.post_id}
              AND user_id = #{params.user_id}
              AND deleted = 0
        )
    </insert>

    <delete id="deleteByPostUser">
        DELETE FROM moment_like
        WHERE post_id = #{postId}
          AND user_id = #{userId}
    </delete>

    <delete id="deleteByPost">
        DELETE FROM moment_like WHERE post_id = #{postId}
    </delete>

    <select id="selectLikesByPostId" resultType="com.shutu.devSphere.model.vo.moment.UserVo">
        SELECT
            l.user_id as uid,
            p.display_name as username,
            p.avatar
        FROM moment_like l
        LEFT JOIN user_profile p ON l.user_id = p.user_id
        WHERE l.post_id = #{postId}
          AND l.deleted = 0
        ORDER BY l.create_time DESC
        LIMIT 10
    </select>
</mapper>
